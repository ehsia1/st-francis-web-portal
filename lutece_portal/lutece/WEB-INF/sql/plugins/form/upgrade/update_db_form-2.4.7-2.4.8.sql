--
-- Table structure for table form_rss_cf
--
DROP TABLE IF EXISTS form_rss_cf;
CREATE TABLE form_rss_cf (
	id_rss int default 0 NOT NULL,
	id_form int default 0 NOT NULL,
	is_submit_rss smallint default 0 NOT NULL,	
	id_form_submit int default 0 NOT NULL,
	PRIMARY KEY (id_rss)
);


--
-- Table structure for table form_category
--
DROP TABLE IF EXISTS form_category;
CREATE TABLE form_category (
	id_category int NOT NULL,
	title varchar(100) NOT NULL,
	color varchar(10),
	PRIMARY KEY (id_category)
);

ALTER TABLE form_form ADD COLUMN id_category int default NULL;
ALTER TABLE form_form ADD CONSTRAINT fk_form_form_category FOREIGN KEY (id_category)
	REFERENCES form_category (id_category);

--
-- FORM-125 : Add the possibility to include the response file as email attachment for the OutputProcessor Notify Sender
--
ALTER TABLE form_notify_sender_configuration ADD COLUMN send_attachments smallint default 0 NOT NULL;

--
-- FORM-135 : CSV export does not have a good behaviour when entries are added or entry positions are changed
--
UPDATE form_export_format SET xsl_file = 0x3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D2249534F2D383835392D31223F3E0D0A3C78736C3A7374796C6573686565742076657273696F6E3D22312E302220786D6C6E733A78736C3D22687474703A2F2F7777772E77332E6F72672F313939392F58534C2F5472616E73666F726D223E0D0A3C78736C3A6F7574707574206D6574686F643D2274657874222F3E0D0A0D0A3C78736C3A74656D706C617465206D617463683D222F223E0D0A093C78736C3A6170706C792D74656D706C617465732073656C6563743D22666F726D2F666F726D2D656E74726965732F666F726D2D656E74727922202F3E0D0A093C78736C3A746578743E262331303B3C2F78736C3A746578743E0D0A093C78736C3A6170706C792D74656D706C617465732073656C6563743D22666F726D2F7375626D6974732F7375626D6974222F3E0D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C78736C3A74656D706C617465206D617463683D22666F726D2F666F726D2D656E74726965732F666F726D2D656E747279223E0D0A093C78736C3A746578743E223C2F78736C3A746578743E0D0A093C78736C3A76616C75652D6F662073656C6563743D22666F726D2D656E7472792D7469746C6522202F3E200D0A093C78736C3A746578743E223B3C2F78736C3A746578743E0D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C78736C3A74656D706C617465206D617463683D22666F726D2F7375626D6974732F7375626D6974223E0D0A093C78736C3A7661726961626C65206E616D653D227375626D69742D6964222073656C6563743D227375626D69742D696422202F3E0D0A093C78736C3A666F722D656163682073656C6563743D222E2E2F2E2E2F666F726D2D656E74726965732F666F726D2D656E747279223E0D0A09093C78736C3A7661726961626C65206E616D653D22666F726D2D656E7472792D6964222073656C6563743D22666F726D2D656E7472792D696422202F3E0D0A09093C78736C3A63686F6F73653E0D0A0909093C78736C3A7768656E20746573743D22737472696E67282E2E2F2E2E2F7375626D6974732F7375626D69745B7375626D69742D69643D247375626D69742D69645D2F7175657374696F6E732F7175657374696F6E5B7175657374696F6E2D69643D24666F726D2D656E7472792D69645D29223E0D0A090909093C78736C3A6170706C792D74656D706C617465732073656C6563743D222E2E2F2E2E2F7375626D6974732F7375626D69745B7375626D69742D69643D247375626D69742D69645D2F7175657374696F6E732F7175657374696F6E5B7175657374696F6E2D69643D24666F726D2D656E7472792D69645D222F3E0D0A0909093C2F78736C3A7768656E3E0D0A0909093C78736C3A6F74686572776973653E0D0A090909093C78736C3A746578743E22223B3C2F78736C3A746578743E0D0A0909093C2F78736C3A6F74686572776973653E0D0A09093C2F78736C3A63686F6F73653E0D0A093C2F78736C3A666F722D656163683E0D0A093C78736C3A746578743E262331303B3C2F78736C3A746578743E0D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C78736C3A74656D706C617465206D617463683D227175657374696F6E732F7175657374696F6E223E0D0A093C78736C3A6170706C792D74656D706C617465732073656C6563743D22726573706F6E736573222F3E200D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C78736C3A74656D706C617465206D617463683D227175657374696F6E732F7175657374696F6E2F726573706F6E736573223E0D0A093C78736C3A746578743E223C2F78736C3A746578743E0D0A093C78736C3A6170706C792D74656D706C617465732073656C6563743D22726573706F6E7365222F3E0D0A093C78736C3A746578743E223B3C2F78736C3A746578743E0D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C78736C3A74656D706C617465206D617463683D227175657374696F6E732F7175657374696F6E2F726573706F6E7365732F726573706F6E7365223E0D0A093C78736C3A76616C75652D6F662073656C6563743D222E222F3E0D0A093C78736C3A696620746573743D22706F736974696F6E2829213D6C6173742829223E0D0A09093C78736C3A746578743E3B3C2F78736C3A746578743E0D0A093C2F78736C3A69663E0D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C2F78736C3A7374796C6573686565743E0D0A
WHERE id_export = 1;

--
-- FORM-136 : Change the type of the column "form_response.response_value" 
-- from "LONG VARBINARY" to "LONG VARCHAR" and add 2 new tables to store 
-- response files
--

-- Create tables
DROP TABLE IF EXISTS form_file;
CREATE TABLE form_file (
  id_file INT DEFAULT 0 NOT NULL,
  title LONG VARCHAR DEFAULT NULL,
  id_physical_file INT DEFAULT NULL,
  file_size INT DEFAULT NULL,
  mime_type VARCHAR(255) DEFAULT NULL,
  PRIMARY KEY (id_file)
);
DROP TABLE IF EXISTS form_physical_file;
CREATE TABLE form_physical_file (
  id_physical_file INT DEFAULT 0 NOT NULL,
  file_value LONG VARBINARY,
  PRIMARY KEY (id_physical_file)
);

-- Transfer file data from form_response to form_file and form_physical_file
INSERT INTO form_physical_file ( id_physical_file, file_value )
	SELECT fr.id_response, fr.response_value 
	FROM form_response fr 
	WHERE fr.file_name IS NOT NULL AND fr.file_name != ''
	ORDER BY fr.id_response ASC;
INSERT INTO form_file ( id_file, title, id_physical_file, file_size )
	SELECT fr.id_response, fr.file_name, fr.id_response, length( fr.response_value ) 
	FROM form_response fr 
	WHERE fr.file_name IS NOT NULL AND fr.file_name != ''
	ORDER BY fr.id_response ASC;

-- Delete content form_response rows that are files
UPDATE form_response SET response_value = NULL WHERE file_name IS NOT NULL AND file_name != '';

-- Add id_file. For existing data, id_file = id_response for simplicity purpose
ALTER TABLE form_response ADD COLUMN id_file INT DEFAULT NULL;
UPDATE form_response SET id_file = id_response WHERE file_name IS NOT NULL AND file_name != '';

-- Change response_value column type
ALTER TABLE form_response ADD COLUMN response_value_tmp LONG VARCHAR DEFAULT NULL;
UPDATE form_response SET response_value_tmp = CONVERT(CAST(response_value AS CHAR CHARACTER SET latin1) USING utf8);
ALTER TABLE form_response DROP COLUMN response_value;
ALTER TABLE form_response CHANGE COLUMN response_value_tmp response_value LONG VARCHAR DEFAULT NULL;

-- Delete columns
ALTER TABLE form_response DROP COLUMN file_name;
ALTER TABLE form_response DROP COLUMN file_extension;

--
-- DIRECTORY-139 : Encoding problem with the CSV Export functionnality
--
INSERT INTO form_form_parameter (parameter_key, parameter_value) VALUES ('export_csv_encoding', 'UTF-8');
INSERT INTO form_form_parameter (parameter_key, parameter_value) VALUES ('export_xml_encoding', 'UTF-8');
UPDATE form_export_format SET xsl_file = 0x3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0D0A3C78736C3A7374796C6573686565742076657273696F6E3D22312E302220786D6C6E733A78736C3D22687474703A2F2F7777772E77332E6F72672F313939392F58534C2F5472616E73666F726D223E0D0A3C78736C3A6F7574707574206D6574686F643D22786D6C222076657273696F6E3D22312E302220656E636F64696E673D225554462D382220696E64656E743D22796573222063646174612D73656374696F6E2D656C656D656E74733D22726573706F6E7365207175657374696F6E2D7469746C6520666F726D2D7469746C65222F3E0D0A3C78736C3A74656D706C617465206D617463683D222F223E0D0A203C78736C3A6170706C792D74656D706C617465732073656C6563743D22666F726D222F3E200D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C78736C3A74656D706C617465206D617463683D22666F726D223E0D0A093C666F726D3E0D0A09093C666F726D2D7469746C653E0D0A0909093C78736C3A76616C75652D6F662073656C6563743D22666F726D2D7469746C65222F3E0D0A09093C2F666F726D2D7469746C653E0D0A09093C7375626D6974733E0D0A0909093C78736C3A6170706C792D74656D706C617465732073656C6563743D227375626D6974732F7375626D6974222F3E200D0A09093C2F7375626D6974733E0D0A093C2F666F726D3E090D0A3C2F78736C3A74656D706C6174653E0D0A0D0A3C78736C3A74656D706C617465206D617463683D227375626D6974223E0D0A093C7375626D69743E0D0A09093C7375626D69742D69643E0D0A0909093C78736C3A76616C75652D6F662073656C6563743D227375626D69742D6964222F3E0D0A09093C2F7375626D69742D69643E0D0A09093C7375626D69742D646174653E0D0A0909093C78736C3A76616C75652D6F662073656C6563743D227375626D69742D64617465222F3E0D0A09093C2F7375626D69742D646174653E0D0A09093C7375626D69742D69703E0D0A0909093C78736C3A76616C75652D6F662073656C6563743D227375626D69742D6970222F3E0D0A09093C2F7375626D69742D69703E0D0A09093C7175657374696F6E733E0D0A0909093C78736C3A6170706C792D74656D706C617465732073656C6563743D227175657374696F6E732F7175657374696F6E222F3E200D0A09093C2F7175657374696F6E733E0D0A093C2F7375626D69743E0D0A3C2F78736C3A74656D706C6174653E0D0A3C78736C3A74656D706C617465206D617463683D227175657374696F6E223E0D0A093C7175657374696F6E3E0D0A09093C7175657374696F6E2D7469746C653E0D0A0909093C78736C3A76616C75652D6F662073656C6563743D227175657374696F6E2D7469746C65222F3E0D0A09093C2F7175657374696F6E2D7469746C653E0D0A09093C726573706F6E7365733E0D0A0909093C78736C3A6170706C792D74656D706C617465732073656C6563743D22726573706F6E7365732F726573706F6E7365222F3E200D0A09093C2F726573706F6E7365733E0D0A093C2F7175657374696F6E3E0D0A3C2F78736C3A74656D706C6174653E0D0A3C78736C3A74656D706C617465206D617463683D22726573706F6E7365223E0D0A093C726573706F6E73653E0D0A09093C78736C3A76616C75652D6F662073656C6563743D222E222F3E0D0A093C2F726573706F6E73653E0D0A3C2F78736C3A74656D706C6174653E0D0A3C2F78736C3A7374796C6573686565743E
WHERE id_export = 2;
